<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AR.js â€“ Lock Once</title>

    <!-- A-Frame -->
    <script src="https://unpkg.com/aframe@1.5.0/dist/aframe.min.js"></script>
    <!-- AR.js for A-Frame -->
    <script src="https://unpkg.com/ar.js@3.4.5/aframe/build/aframe-ar.js"></script>

    <script>
      // Helper: copy world transform (pos/quat/scale) from one object3D to another A-Frame entity
      function copyWorldTransformToEntity(srcObj3D, dstEl) {
        const p = new THREE.Vector3();
        const q = new THREE.Quaternion();
        const s = new THREE.Vector3();
        srcObj3D.updateMatrixWorld(true);
        srcObj3D.matrixWorld.decompose(p, q, s);

        // Apply to destination (its parent is the scene)
        const euler = new THREE.Euler().setFromQuaternion(q, 'YXZ');
        dstEl.object3D.position.copy(p);
        dstEl.object3D.quaternion.copy(q);
        dstEl.object3D.scale.copy(s);
        dstEl.object3D.rotation.set(euler.x, euler.y, euler.z);
      }

      // Component: one-time lock after marker is found (no UI)
      AFRAME.registerComponent('lock-once-on-detect', {
        schema: {
          marker: { type: 'selector' },   // the tracking marker entity
          settleFrames: { default: 8 },   // collect a few frames to let pose stabilize
          useSmoothingInstead: { default: false } // set true to use smoothed-controls option
        },
        init: function () {
          this._found = false;
          this._frameCount = 0;

          const markerEl = this.data.marker;
          if (!markerEl) {
            console.warn('[lock-once-on-detect] marker not provided.');
            return;
          }

          // If you prefer smoothing instead of hard lock, enable this block:
          if (this.data.useSmoothingInstead) {
            // Build a smoothed proxy that follows the marker with damping
            const smoothed = document.createElement('a-entity');
            smoothed.setAttribute('id', 'smoothed-proxy');
            smoothed.setAttribute('smoothed-controls', {
              markerEl: `#${markerEl.getAttribute('id')}`,
              lerpPosition: 0.4,
              lerpRotation: 0.1,
              lerpScale: 0.4,
              minVisibleDuration: 0.15,   // ignore single-frame flicker
              maxAccumulateTime: 0.5
            });
            this.el.sceneEl.appendChild(smoothed);

            // Reparent our model under the smoothed proxy (comment out if hard-locking)
            smoothed.appendChild(this.el);
            return; // nothing else to do when smoothing
          }

          // Hard-lock flow
          markerEl.addEventListener('markerFound', () => {
            this._found = true;
            this._frameCount = 0;
            this.el.setAttribute('visible', true);
          });

          markerEl.addEventListener('markerLost', () => {
            // If we never locked (e.g., user moved too fast), just hide until next find
            if (!this._locked) this.el.setAttribute('visible', false);
          });

          this._locked = false;

          // Per-frame: wait a few frames after detection, then freeze transform
          this.el.sceneEl.addEventListener('renderstart', () => {
            this.el.sceneEl.renderer.setAnimationLoop(() => {
              if (this._locked || !this._found) return;

              this._frameCount++;
              // After settleFrames, snapshot the model's world transform and detach from marker
              if (this._frameCount >= this.data.settleFrames) {
                const model = this.el;                   // model entity to freeze
                const markerObj = markerEl.object3D;     // current marker pose

                // Make a new top-level anchor to hold the frozen transform
                const frozen = document.createElement('a-entity');
                frozen.setAttribute('id', 'frozen-anchor');
                this.el.sceneEl.appendChild(frozen);

                // Copy world transform from the model (currently under marker) to frozen anchor
                // We copy from model.object3D so any local offsets are preserved.
                copyWorldTransformToEntity(model.object3D, frozen);

                // Move the model under the frozen anchor (so it keeps the captured transform)
                frozen.appendChild(model);

                // Optional: hide/disable marker visuals to avoid confusion
                markerEl.setAttribute('visible', false);

                this._locked = true;
              }
            });
          });
        }
      });
    </script>

    <style>
      body { margin: 0; overflow: hidden; }
      .a-enter-vr-button, .a-enter-ar-button { display:none; } /* AR.js handles camera */
    </style>
  </head>

  <body>
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      renderer="precision: high; antialias: true; logarithmicDepthBuffer: true"
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; patternRatio: 0.9;">

      <!-- Camera -->
      <a-entity camera></a-entity>

      <!-- Marker (use preset or your .patt) -->
      <a-marker
        id="marker"
        type="pattern"
        url="p_poster.patt"
        emitevents="true">
        <!-- When hard-locking, the model starts under the marker... -->
        <!-- Replace the box with your GLB/GLTF model entity -->
        <a-entity
          id="model"
          gltf-model="poster.glb"
          position="0 0 0"
          rotation="0 0 0"
          scale="0.5 0.5 0.5"
          lock-once-on-detect="marker: #marker; settleFrames: 8; useSmoothingInstead: false">
          <a-box depth="0.5" height="0.5" width="0.5"></a-box>
          <!-- Example GLTF:
          <a-gltf-model src="#yourModel" position="0 0 0" scale="0.5 0.5 0.5"></a-gltf-model>
          -->
        </a-entity>
      </a-marker>

      <!-- Required for AR.js -->
      <a-entity arjs-anchor></a-entity>
      <a-entity arjs-hit-test></a-entity>

      <!-- Assets (put your model here)
      <a-assets>
        <a-asset-item id="yourModel" src="models/yourModel.glb"></a-asset-item>
      </a-assets>
      -->
    </a-scene>
  </body>
</html>
