<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR.js Auto-Lock</title>

  <!-- A-Frame + AR.js (pattern-marker build) -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>

  <style>html,body{margin:0;height:100%;overflow:hidden;}</style>
</head>
<body>
  <a-scene
    embedded
    renderer="alpha: true; antialias: true"
    arjs="trackingMethod: best; sourceType: webcam; facingMode: environment; debugUIEnabled: false;"
    vr-mode-ui="enabled: false">

    <!-- Marker (events + initial smoothing only to get a clean first pose) -->
    <a-marker id="marker"
              type="pattern"
              url="p_poster.patt"
              emitevents="true"
              smooth="true" smoothCount="15" smoothTolerance="0.01" smoothThreshold="8">
    </a-marker>

    <!-- This follower tracks the marker until we lock it, then stops updating -->
    <a-entity id="smoothed"
              visible="false"
              smoothed-controls="markerEl: #marker; lerpPosition: 0.2; lerpRotation: 0.2; lerpScale: 0.2">
      <a-entity gltf-model="poster.glb"
                position="0 0 0"
                rotation="0 0 0"
                scale="0.6 0.6 0.6"></a-entity>
    </a-entity>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const marker = document.querySelector('#marker');
    const smoothed = document.querySelector('#smoothed');
    let locked = false;

    // Show model when marker is seen; on first time, freeze its transform.
    marker.addEventListener('markerFound', () => {
      smoothed.setAttribute('visible', true);

      if (!locked) {
        // Let smoothed-controls settle for ~2 frames, then freeze.
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            const p = smoothed.object3D.position.clone();
            const r = smoothed.object3D.rotation.clone();

            // Remove the tracking component -> stops following the marker.
            smoothed.removeAttribute('smoothed-controls');

            // Re-apply the last settled transform (absolute lock).
            smoothed.object3D.position.copy(p);
            smoothed.object3D.rotation.copy(r);

            locked = true;
          });
        });
      }
    });

    // No markerLost handler: once locked, it simply stays visible and fixed.
  </script>
</body>
</html>
